<!-- local-sale-details.component.html -->
<div class="card card-xl-stretch mb-6">
  <div class="card-header border-0 pt-5 d-flex justify-content-between align-items-center">
    <h3 class="card-title fw-bolder fs-3 mb-1">{{ 'SALES.LOCAL_SALE.DETAIL.TITLE_' + (style === 'WHOLE' ? 'WHOLE' : 'TAIL') | translate }}</h3>
    <button type="button" class="btn btn-primary btn-sm" (click)="addItem()">
      <i class="bi bi-plus-circle me-1"></i> <span translate="SALES.LOCAL_SALE.DETAIL.ADD_ITEM"></span>
    </button>
  </div>

  <div class="card-body pt-0">
    <!-- Empty State -->
    <div *ngIf="!localSaleDetail || !localSaleDetail.items || localSaleDetail.items.length === 0"
      class="text-center py-5">
      <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
      <h5 class="text-muted mb-2" translate="SALES.LOCAL_SALE.DETAIL.EMPTY_STATE_TITLE"></h5>
      <p class="text-muted mb-3" translate="SALES.LOCAL_SALE.DETAIL.EMPTY_STATE_MESSAGE"></p>
    </div>

    <!-- Items Table -->
    <div *ngIf="localSaleDetail && localSaleDetail.items && localSaleDetail.items.length > 0">
      <div class="mb-3">
        <h6 class="mb-0 fw-bold text-muted" translate="SALES.LOCAL_SALE.DETAIL.ITEMS_TITLE"></h6>
      </div>

      <!-- Detail Items Table -->
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead>
            <tr class="bg-light text-muted fw-bold">
              <th class="text-start" translate="SALES.LOCAL_SALE.DETAIL.TABLE.SIZE"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.POUNDS"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.PRICE"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.TOTAL"></th>
              <th class="text-start" translate="SALES.LOCAL_SALE.DETAIL.TABLE.MERCHANT"></th>
              <th class="text-start" translate="SALES.LOCAL_SALE.DETAIL.TABLE.MERCHANT_ID"></th>
              <th class="text-center" translate="SALES.LOCAL_SALE.DETAIL.TABLE.PAYMENT_STATUS"></th>
              <th class="text-center" translate="SALES.LOCAL_SALE.DETAIL.TABLE.PAYMENT_METHOD"></th>
              <th class="text-center" translate="SALES.LOCAL_SALE.DETAIL.TABLE.HAS_INVOICE"></th>
              <th class="text-center" translate="SALES.LOCAL_SALE.DETAIL.TABLE.INVOICE_NUMBER"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.PAYMENT_ONE"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.PAYMENT_TWO"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.TOTAL_PAYMENT"></th>
              <th class="text-end" translate="SALES.LOCAL_SALE.DETAIL.TABLE.TOTAL_RECEIVED"></th>
              <th class="text-center" translate="SALES.LOCAL_SALE.DETAIL.TABLE.ACTIONS"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of localSaleDetail?.items; let itemIndex = index">
              <!-- Talla -->
              <td>
                <input type="text" [(ngModel)]="item.size" [placeholder]="sizePlaceholder" name="size{{ itemIndex }}"
                  class="form-control form-control-sm" (keypress)="validateSizeFormat($event)" required />
              </td>

              <!-- Libras -->
              <td>
                <input type="number" [(ngModel)]="item.pounds" name="pounds{{ itemIndex }}" #poundsCtrl="ngModel"
                  (ngModelChange)="recalculateTotals(localSaleDetail!)" (keypress)="validateNumber($event)"
                  (blur)="formatDecimal(poundsCtrl)" class="form-control form-control-sm text-end no-spinner"
                  required />
              </td>

              <!-- Precio -->
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" [(ngModel)]="item.price" name="price{{ itemIndex }}" #priceCtrl="ngModel"
                    (ngModelChange)="recalculateTotals(localSaleDetail!)" (keypress)="validateNumber($event)"
                    (blur)="formatDecimal(priceCtrl)" class="form-control form-control-sm text-end no-spinner"
                    required />
                </div>
              </td>

              <!-- Total -->
              <td class="text-end">${{ item.total | number: '1.2-2' }}</td>

              <!-- Comerciante -->
              <td>
                <input type="text" [(ngModel)]="item.merchantName" name="merchantName{{ itemIndex }}"
                  class="form-control form-control-sm" [placeholder]="'SALES.LOCAL_SALE.DETAIL.PLACEHOLDERS.MERCHANT_NAME' | translate" required />
              </td>

              <!-- ID Comerciante -->
              <td>
                <input type="text" [(ngModel)]="item.merchantId" name="merchantId{{ itemIndex }}"
                  class="form-control form-control-sm" [placeholder]="'SALES.LOCAL_SALE.DETAIL.PLACEHOLDERS.MERCHANT_ID' | translate" required />
              </td>

              <!-- Estado Pago -->
              <td>
                <select class="form-select form-select-sm" [(ngModel)]="item.paymentStatus"
                  name="paymentStatus{{ itemIndex }}" (ngModelChange)="onPaymentStatusChange(item, $event)" required>
                  <option *ngFor="let status of paymentStatuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
              </td>

              <!-- Método Pago -->
              <td>
                <select class="form-select form-select-sm" [value]="getSelectedPaymentMethodId(item)"
                  name="paymentMethod{{ itemIndex }}" (change)="onPaymentMethodChange(item, $any($event.target).value)"
                  [disabled]="!isPaymentMethodRequired(item)"
                  [class.is-invalid]="isPaymentMethodRequired(item) && !getSelectedPaymentMethodId(item)">
                  <option value="">{{ 'SALES.LOCAL_SALE.DETAIL.PLACEHOLDERS.SELECT' | translate }}</option>
                  <option *ngFor="let method of paymentMethods" [value]="method.id">
                    {{ method.name }}
                  </option>
                </select>
                <div *ngIf="isPaymentMethodRequired(item) && !getSelectedPaymentMethodId(item)"
                  class="invalid-feedback d-block small">
                  {{ 'SALES.LOCAL_SALE.DETAIL.VALIDATIONS.PAYMENT_METHOD_REQUIRED' | translate }}
                </div>
              </td>

              <!-- Factura -->
              <td>
                <select class="form-select form-select-sm" [(ngModel)]="item.hasInvoice"
                  name="hasInvoice{{ itemIndex }}" (ngModelChange)="onInvoiceChange(item, $event)"
                  [disabled]="item.paymentStatus !== 'PAID'" required>
                  <option *ngFor="let option of invoiceOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </td>

              <!-- Núm. Factura -->
              <td>
                <input type="text" [(ngModel)]="item.invoiceNumber" name="invoiceNumber{{ itemIndex }}"
                  class="form-control form-control-sm" [placeholder]="'SALES.LOCAL_SALE.DETAIL.PLACEHOLDERS.NUMBER' | translate" [disabled]="!isInvoiceNumberRequired(item)"
                  [class.is-invalid]="isInvoiceNumberRequired(item) && !item.invoiceNumber" />
                <div *ngIf="isInvoiceNumberRequired(item) && !item.invoiceNumber"
                  class="invalid-feedback d-block small">
                  {{ 'SALES.LOCAL_SALE.DETAIL.VALIDATIONS.INVOICE_NUMBER_REQUIRED' | translate }}
                </div>
              </td>

              <!-- Pago 1 -->
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" [(ngModel)]="item.paymentOne" name="paymentOne{{ itemIndex }}"
                    #paymentOneCtrl="ngModel" (blur)="formatDecimal(paymentOneCtrl)"
                    class="form-control form-control-sm text-end no-spinner" />
                </div>
              </td>

              <!-- Pago 2 -->
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" [(ngModel)]="item.paymentTwo" name="paymentTwo{{ itemIndex }}"
                    #paymentTwoCtrl="ngModel" (blur)="formatDecimal(paymentTwoCtrl)"
                    class="form-control form-control-sm text-end no-spinner" />
                </div>
              </td>

              <!-- Total Pago -->
              <td class="text-end">${{ getTotalPago(item) | number: '1.2-2' }}</td>

              <!-- Total Recibido -->
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" [(ngModel)]="item.totalReceived" name="totalReceived{{ itemIndex }}"
                    #totalReceivedCtrl="ngModel" (ngModelChange)="recalculateTotals(localSaleDetail!)"
                    (blur)="formatDecimal(totalReceivedCtrl)"
                    class="form-control form-control-sm text-end no-spinner" />
                </div>
              </td>

              <!-- Acciones -->
              <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" (click)="removeItem(itemIndex)">
                  <i class="bi bi-x"></i>
                </button>
              </td>
            </tr>

            <!-- Totals Row -->
            <tr class="fw-bold bg-light">
              <td translate="SALES.LOCAL_SALE.DETAIL.SUBTOTAL"></td>
              <td class="text-end">{{ localSaleDetail.poundsGrandTotal | number: '1.2-2' }}</td>
              <td></td>
              <td class="text-end">${{ localSaleDetail.grandTotal | number: '1.2-2' }}</td>
              <td colspan="9"></td>
              <td colspan="2" class="text-start">${{ localSaleDetail.receivedGrandTotal | number: '1.2-2' }}</td>
            </tr>

            <!-- Retention Percentage Row -->
            <tr class="bg-light">
              <td colspan="3" class="text-end fw-semibold" translate="SALES.LOCAL_SALE.DETAIL.RETENTION_PERCENTAGE"></td>
              <td>
                <input type="number" [(ngModel)]="localSaleDetail.retentionPercentage" name="retentionPercentage"
                  #retentionPercentageCtrl="ngModel" (ngModelChange)="onRetentionPercentageChange(localSaleDetail!)"
                  (blur)="formatDecimal(retentionPercentageCtrl)" (keypress)="validateNumber($event)"
                  class="form-control form-control-sm text-end no-spinner" min="0" max="100" step="0.01" />
              </td>
              <td colspan="11"></td>
            </tr>

            <!-- Retention Amount Row -->
            <tr class="bg-light">
              <td colspan="3" class="text-end fw-semibold" translate="SALES.LOCAL_SALE.DETAIL.RETENTION_AMOUNT"></td>
              <td class="text-end fw-bold">${{ localSaleDetail.retentionAmount | number: '1.2-2' }}</td>
              <td colspan="11"></td>
            </tr>

            <!-- Other Penalties Row -->
            <tr class="bg-light">
              <td colspan="3" class="text-end fw-semibold" translate="SALES.LOCAL_SALE.DETAIL.ADDITIONAL_PENALTIES"></td>
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">$</span>
                  <input type="number" [(ngModel)]="localSaleDetail.otherPenalties" name="otherPenalties"
                    #otherPenaltiesCtrl="ngModel" (ngModelChange)="onOtherPenaltiesChange(localSaleDetail!)"
                    (blur)="formatDecimal(otherPenaltiesCtrl)" (keypress)="validateNumber($event)"
                    class="form-control form-control-sm text-end no-spinner" min="0" step="0.01" />
                </div>
              </td>
              <td colspan="11"></td>
            </tr>

            <!-- Net Grand Total Row -->
            <tr class="fw-bold bg-light border-top border-2">
              <td colspan="3" class="text-end" translate="SALES.LOCAL_SALE.DETAIL.NET_TOTAL"></td>
              <td class="text-end text-success fs-6">${{ localSaleDetail.netGrandTotal | number: '1.2-2' }}</td>
              <td colspan="11"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
