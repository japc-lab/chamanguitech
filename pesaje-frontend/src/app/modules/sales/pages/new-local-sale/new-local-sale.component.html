<!-- First Section: Search Info -->
<div class="card card-xl-stretch mb-xl-8">
  <div class="card-header border-0 pt-5 d-flex justify-content-between align-items-center">
    <h4 class="card-title align-items-start flex-column">
      <span class="card-label fw-bolder fs-3 mb-1" translate="SALES.LOCAL_SALE.SECTIONS.SEARCH_INFO"></span>
    </h4>

    <div class="d-flex gap-2">
      <!-- Back Button -->
      <button *ngIf="saleId" type="button" class="btn btn-light btn-sm" (click)="goBack()">
        <i class="bi bi-arrow-left me-1"></i> <span translate="SALES.LOCAL_SALE.BUTTONS.BACK"></span>
      </button>

      <!-- New Button -->
      <button *ngIf="localSaleId" type="button" class="btn btn-outline-success btn-sm" (click)="handleNewSale()">
        <i class="bi bi-plus-circle me-1"></i> <span translate="SALES.LOCAL_SALE.BUTTONS.NEW"></span>
      </button>
    </div>
  </div>
  <div class="card-body py-3">
    <div class="d-flex flex-column">
      <div class="d-flex align-items-center gap-4">
        <!-- Control Number Input -->
        <input type="text" id="controlNumber" name="controlNumber" class="form-control form-control-sm text-end"
          [placeholder]="'SALES.LOCAL_SALE.PLACEHOLDERS.CONTROL_NUMBER' | translate" style="max-width: 180px" [disabled]="!!localSaleId" [(ngModel)]="controlNumber" />

        <!-- Search Button -->
        <button *ngIf="!localSaleId" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2"
          (click)="searchPurchase()">
          <i class="bi bi-search"></i> <span translate="SALES.LOCAL_SALE.BUTTONS.SEARCH"></span>
        </button>
      </div>

      <!-- Required Message -->
      <div *ngIf="searchSubmitted && !controlNumber" class="text-danger mt-1 ms-1 small">
        {{ 'SALES.LOCAL_SALE.VALIDATIONS.CONTROL_NUMBER_REQUIRED' | translate }}
      </div>
    </div>

  </div>
</div>
<!-- end::First Section: Search Info -->

<!-- Second Section: Purchase Info -->
<div class="card card-xl-stretch mb-xl-8 mt-2">

  <!-- begin::Header -->
  <div class="card-header border-0 pt-5">
    <h4 class="card-title align-items-start flex-column">
      <span class="card-label fw-bolder fs-3 mb-1" translate="SALES.LOCAL_SALE.SECTIONS.PURCHASE_INFO"></span>
    </h4>
  </div>
  <!-- end::Header -->

  <!-- begin::Body -->
  <div class="card-body py-3">

    <div class="row g-5 g-xl-8">
      <!-- Purchase Date -->
      <div class="col-md-6">
        <label for="purchaseDate" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.PURCHASE_DATE"></label>
        <input type="date" class="form-control form-control-sm" id="purchaseDate" name="purchaseDate"
          [(ngModel)]="purchaseDateFormatted" disabled>
      </div>

      <!-- Buyer -->
      <div class="col-md-6">
        <label for="buyer" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.BUYER"></label>
        <input type="text" id="buyer" name="buyer" class="form-control form-control-sm"
          [(ngModel)]="purchaseModel.buyer.fullName" disabled />
      </div>

      <!-- Client -->
      <div class="col-md-6">
        <label for="company" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.CLIENT"></label>
        <input type="text" id="company" name="company" class="form-control form-control-sm"
          [(ngModel)]="purchaseModel.client.fullName" disabled />
      </div>

      <!-- Shrimp Farm -->
      <div class="col-md-6">
        <label for="shrimpFarm" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.SHRIMP_FARM"></label>
        <input type="text" id="shrimpFarm" name="shrimpFarm" class="form-control form-control-sm"
          [(ngModel)]="purchaseModel.shrimpFarm.identifier" disabled />
      </div>

      <!-- Farm Place-->
      <div class="col-md-6">
        <label for="farmPlace" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.FARM_PLACE"></label>
        <input type="text" id="farmPlace" name="farmPlace" class="form-control form-control-sm"
          [(ngModel)]="purchaseModel.shrimpFarm.place" disabled />
      </div>

      <!-- Total pounds -->
      <div class="col-md-6">
        <label for="transportationMethod" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.TOTAL_POUNDS_PURCHASED"></label>
        <input type="text" id="transportationMethod" name="transportationMethod" class="form-control form-control-sm"
          [value]="purchaseModel.totalPounds | number: '1.2-2'" disabled />
      </div>

      <!-- Weight Sheet Number -->
      <div class="col-md-6">
        <label for="weightSheetNumber" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.WEIGHT_SHEET_NUMBER_PURCHASE"></label>
        <input type="text" id="weightSheetNumber" name="weightSheetNumber" class="form-control form-control-sm"
          [(ngModel)]="purchaseModel.weightSheetNumber" disabled />
      </div>
    </div>
  </div>
</div>
<!-- end::Second Section: Purchase Info -->

<!-- Sale Form -->
<form #saleForm="ngForm" novalidate>

  <!-- Third Section: Sale Info -->
  <div class="card card-xl-stretch mb-xl-8 mt-2">
    <!-- begin::Header -->
  <div class="card-header border-0 pt-8">
    <div class="d-flex flex-column">
      <h4 class="card-title align-items-start flex-column">
        <span class="card-label fw-bolder fs-3 mb-1" translate="SALES.LOCAL_SALE.SECTIONS.SALE_INFO"></span>
      </h4>
      <!-- Draft Indicator -->
      <span *ngIf="localSaleId && localSaleModel.status === LocalSaleStatusEnum.DRAFT"
        class="badge badge-warning fs-7 mt-1">
        <i class="bi bi-pencil-square me-1"></i> <span translate="LOGISTICS.STATUS.DRAFT"></span>
      </span>
    </div>
  </div>
    <!-- end::Header -->

    <!-- begin::Body -->
    <div class="card-body py-3">
      <!-- begin::Row -->
      <div class="row g-5 g-xl-8">

        <!-- Sale Date -->
        <div class="col-md-6">
          <label for="saleDate" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.SALE_DATE"></label>
          <input type="date" class="form-control form-control-sm" id="saleDate" name="saleDate"
            [ngModel]="saleDateFormatted" (ngModelChange)="onDateChange($event)"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" #saleDate="ngModel">
          <div
            *ngIf="(saleForm.submitted || saleDate.dirty || saleDate.touched) && saleDate.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            <div>{{ 'SALES.LOCAL_SALE.VALIDATIONS.SALE_DATE_REQUIRED' | translate }}</div>
          </div>
        </div>

        <!-- Seller -->
        <div class="col-md-6">
          <label for="seller" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.SELLER"></label>
          <input type="text" id="seller" name="seller" [(ngModel)]="localSaleModel.seller" #seller="ngModel"
            class="form-control form-control-sm" [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" />
          <div
            *ngIf="(saleForm.submitted || seller.dirty || seller.touched) && seller.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            {{ 'SALES.LOCAL_SALE.VALIDATIONS.SELLER_REQUIRED' | translate }}
          </div>
        </div>

        <!-- Weight Sheet Number -->
        <div class="col-md-6">
          <label for="weightSheetNumber" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.WEIGHT_SHEET_NUMBER"></label>
          <input type="text" id="weightSheetNumber" name="weightSheetNumber"
            [(ngModel)]="localSaleModel.weightSheetNumber" #weightSheetNumber="ngModel"
            (keypress)="validateNumber($event)" (blur)="formatWeightSheetNumberOnBlur($event)"
            (focus)="onWeightSheetNumberFocus($event)" class="form-control form-control-sm" maxlength="8"
            [placeholder]="'SALES.LOCAL_SALE.PLACEHOLDERS.WEIGHT_SHEET_NUMBER' | translate"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" />
          <div
            *ngIf="(saleForm.submitted || weightSheetNumber.dirty || weightSheetNumber.touched) && weightSheetNumber.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            <div>{{ 'SALES.LOCAL_SALE.VALIDATIONS.WEIGHT_SHEET_NUMBER_REQUIRED' | translate }}</div>
          </div>
        </div>

        <!-- Has Invoice Selector & Invoice Number (Second Row) -->
        <div class="col-md-6">
          <label for="hasInvoice" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.HAS_INVOICE"></label>
          <select id="hasInvoice" name="hasInvoice" class="form-select form-select-sm"
            [(ngModel)]="localSaleModel.hasInvoice" (ngModelChange)="onHasInvoiceChange($event)" #hasInvoice="ngModel"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT">
            <option [ngValue]="undefined" disabled selected>{{ 'SALES.LOCAL_SALE.PLACEHOLDERS.SELECT_OPTION' | translate }}</option>
            <option [ngValue]="'yes'">{{ 'PURCHASES.OPTIONS.YES' | translate }}</option>
            <option [ngValue]="'no'">{{ 'PURCHASES.OPTIONS.NO' | translate }}</option>
            <option [ngValue]="'not-applicable'">{{ 'PURCHASES.OPTIONS.NOT_APPLICABLE' | translate }}</option>
          </select>
          <div
            *ngIf="(saleForm.submitted || hasInvoice.dirty || hasInvoice.touched) && hasInvoice.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            <div>{{ 'SALES.LOCAL_SALE.VALIDATIONS.HAS_INVOICE_REQUIRED' | translate }}</div>
          </div>
        </div>

        <!-- Invoice Number -->
        <div class="col-md-6" *ngIf="localSaleModel.hasInvoice === 'yes'">
          <label for="invoiceNumber" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.INVOICE_NUMBER"></label>
          <input type="text" id="invoiceNumber" name="invoiceNumber" [(ngModel)]="localSaleModel.invoiceNumber"
            #invoiceNumber="ngModel" class="form-control form-control-sm"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" />
          <div
            *ngIf="(saleForm.submitted || invoiceNumber.dirty || invoiceNumber.touched) && invoiceNumber.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            {{ 'SALES.LOCAL_SALE.VALIDATIONS.INVOICE_NUMBER_REQUIRED' | translate }}
          </div>
        </div>

        <!-- Invoice Name -->
        <div class="col-md-6" *ngIf="localSaleModel.hasInvoice === 'yes'">
          <label for="invoiceName" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.INVOICE_NAME"></label>
          <input type="text" id="invoiceName" name="invoiceName" [(ngModel)]="localSaleModel.invoiceName"
            #invoiceName="ngModel" class="form-control form-control-sm"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" />
          <div
            *ngIf="(saleForm.submitted || invoiceName.dirty || invoiceName.touched) && invoiceName.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            {{ 'SALES.LOCAL_SALE.VALIDATIONS.INVOICE_NAME_REQUIRED' | translate }}
          </div>
        </div>

        <!-- wholeRejectedPounds -->
        <div class="col-md-6">
          <label for="wholeRejectedPounds" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.WHOLE_REJECTED_POUNDS"></label>
          <input type="text" id="wholeRejectedPounds" name="wholeRejectedPounds"
            [(ngModel)]="localSaleModel.wholeRejectedPounds" #wholeRejectedPounds="ngModel"
            class="form-control form-control-sm" [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            (keypress)="validateNumber($event)" (blur)="formatDecimal('wholeRejectedPounds')" />
          <div
            *ngIf="(saleForm.submitted || wholeRejectedPounds.dirty || wholeRejectedPounds.touched) && wholeRejectedPounds.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            {{ 'SALES.LOCAL_SALE.VALIDATIONS.FIELD_REQUIRED' | translate }}
          </div>
        </div>

        <!-- trashPounds -->
        <div class="col-md-6">
          <label for="trashPounds" class="fw-semibold fs-6 mb-2"
            [class.required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            translate="SALES.LOCAL_SALE.FIELDS.TRASH_POUNDS"></label>
          <input type="text" id="trashPounds" name="trashPounds" [(ngModel)]="localSaleModel.trashPounds"
            #trashPounds="ngModel" class="form-control form-control-sm"
            [required]="localSaleModel.status !== LocalSaleStatusEnum.DRAFT" (keypress)="validateNumber($event)"
            (blur)="formatDecimal('trashPounds')" />
          <div
            *ngIf="(saleForm.submitted || trashPounds.dirty || trashPounds.touched) && trashPounds.errors?.['required'] && localSaleModel.status !== LocalSaleStatusEnum.DRAFT"
            class="fv-plugins-message-container fv-plugins-message-container--enabled invalid-feedback">
            {{ 'SALES.LOCAL_SALE.VALIDATIONS.FIELD_REQUIRED' | translate }}
          </div>
        </div>

        <!-- wholeTotalPounds -->
        <div class="col-md-6">
          <label for="wholeTotalPounds" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.WHOLE_TOTAL_POUNDS"></label>
          <input type="text" id="wholeTotalPounds" name="wholeTotalPounds" class="form-control form-control-sm text-end"
            [value]="localSaleModel.wholeTotalPounds | number: '1.2-2'" disabled />
        </div>

        <!-- moneyIncomeForRejectedHeads -->
        <div class="col-md-6">
          <label for="moneyIncomeForRejectedHeads" class="fw-semibold fs-6 mb-2"
            translate="SALES.LOCAL_SALE.FIELDS.MONEY_INCOME_FOR_REJECTED_HEADS"></label>
          <span class="input-group">
            <span class="input-group-text">$</span>
            <input type="text" id="moneyIncomeForRejectedHeads" name="moneyIncomeForRejectedHeads"
              [(ngModel)]="localSaleModel.moneyIncomeForRejectedHeads" #moneyIncomeForRejectedHeads="ngModel"
              class="form-control form-control-sm" (keypress)="validateNumber($event)"
              (blur)="formatDecimal('moneyIncomeForRejectedHeads')" />
          </span>
        </div>

        <!-- totalProcessedPounds -->
        <div class="col-md-6">
          <label for="totalProcessedPounds" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.TOTAL_PROCESSED_POUNDS"></label>
          <input type="text" id="totalProcessedPounds" name="totalProcessedPounds"
            class="form-control form-control-sm text-end" [value]="totalProcessedPounds | number: '1.2-2'" disabled />
        </div>

        <!-- processedRatio -->
        <div class="col-md-6">
          <label for="processedRatio" class="fw-semibold fs-6 mb-2" translate="SALES.LOCAL_SALE.FIELDS.PROCESSED_RATIO"></label>
          <input type="text" id="processedRatio" name="processedRatio" class="form-control form-control-sm text-end"
            [value]="processedRatioDisplay" disabled />
        </div>
      </div>
    </div>
  </div>
  <!-- end::Third Section: Sale Info -->
</form>

<!-- end::Sale Form -->

<!-- Fourth Section: Local Sale Details -->
<div class="row mt-2 gx-4 gy-4">
  <!-- WHOLE -->
  <div class="col-12">
    <app-local-sale-detail [style]="SaleStyleEnum.WHOLE" [localSaleDetail]="localSaleWholeDetail"
      [paymentMethods]="paymentMethods" (localSaleDetailChange)="handleLocalSaleWholeDetailChange($event)" />
  </div>

  <!-- TAIL -->
  <div class="col-12">
    <app-local-sale-detail [style]="SaleStyleEnum.TAIL" [localSaleDetail]="localSaleTailDetail"
      [paymentMethods]="paymentMethods" (localSaleDetailChange)="handleLocalSaleTailDetailChange($event)" />
  </div>

  <!-- LOCAL - COMPANY SALE DETAILS -->
  <div class="col-12">
    <app-local-company-sale-detail [localCompanySaleDetail]="localCompanySaleDetail"
      (localCompanySaleDetailChange)="handleLocalCompanySaleDetailChange($event)"
      (paymentsUpdated)="refreshCompanyPaymentTotal()" />
  </div>
</div>

<!-- end::Fourth Section: Local Sale Details -->

<!-- Fifth Section: Summary -->
<div class="card card-xl-stretch mb-xl-8 mt-2">
  <!-- Summary Section -->
  <app-local-sale-summary [purchaseModel]="purchaseModel" [localSaleModel]="localSaleModel"
    [companyPaymentTotal]="companyPaymentTotal">
  </app-local-sale-summary>

  <div class="card-footer d-flex justify-content-end py-6 px-9">
    <!-- Submit Button -->
    <button type="button" class="btn btn-primary" [disabled]="canSaveLocalSale()" (click)="confirmSave()">
      {{ 'BUTTONS.SAVE' | translate }}
    </button>
  </div>
</div>
<!-- end::Fifth Section: Summary -->
